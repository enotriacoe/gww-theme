---
category:
shop_by_price: false
products:
limit: {{theme_settings.categorypage_products_per_page}}
---
{{inject "categoryProductsPerPage" theme_settings.categorypage_products_per_page}}
{{#partial "head"}}
{{#if pagination.category.previous}}
<link rel="prev" href="{{pagination.category.previous}}">
{{/if}}
{{#if pagination.category.next}}
<link rel="next" href="{{pagination.category.next}}">
{{/if}}
{{/partial}}

{{#partial "page"}}

{{> components/common/breadcrumbs breadcrumbs=breadcrumbs}}

<div class="page">
    {{> components/category/category-header}}    
    <main class="page-content grid-with-sub-items" id="product-listing-container">
        {{#if category.subcategories}}
        <div class="productGrid"> 
            {{#each category.subcategories}}
            <div class="group-item product country-item">
                
                <div class="group-item-flag">
                    <img src="{{cdn (concat (concat 'img/flags/4x3/' (dashcase name)) '.svg')}}">
                </div>
                <a class="close-sub-items" href="javascript:void(0)"><i class="fal fa-times-circle"></i></a>
                <a href="{{url}}" alt="See all {{name}}" title="See all Wine"></a><h3 class="stylised-slim">{{name}}</h3></a>
                <a class="group-item-options {{dashcase name}}-option-toggle" href="javascript:void(0)" data-target="{{dashcase name}}-item" alt="{{name}} - Food Options Choices" title="{{name}} - Food Options Choices">See regions <i class="fal fa-chevron-circle-down"></i></a>
                <ul class="group-sub-items {{dashcase name}}-sub-items">
                </ul>
                <a href="{{url}}" class="btn btn-coral-line" alt="See all {{name}}" title="See all Wine">See all Wine</a>
                
                
            </div>
            {{/each}}
        </div>
        {{/if}}
    </main>
</div>


{{/partial}}
{{> layout/base}}

<script>
    function convertToKebabCase(string) {
        /* This is to match the kebab-casing of the category names by BigCommerce/Handlebars
        We first replace any spaces with hyphens, then switch any full stops for hyphens, 
        before removing any possible trailing hyphen and lowercasing the whole string.
        */
        return string.replace(/\s+/g, '-').replace(/\./g, '-').replace(/-$/, "").toLowerCase();
    }

    function displayRegions(dataReturned){
        // Get all of the countries from the API/Proxy
        let countryList = dataReturned.data[0].children;
        let currentRegionName, currentRegionUrl, currentCountry, currentRegionToggle, currentRegionList;
        
        // Loop through each country and display 
        for (let i = 0, length = countryList.length; i < length; i++){
            currentCountry = convertToKebabCase(countryList[i].name);
            currentRegionToggle = document.querySelector('.' + currentCountry + '-option-toggle');
            currentRegionList = document.querySelector('.' + currentCountry + '-sub-items');
            if (currentRegionList) {
                currentRegionToggle.classList.add("display-toggle");
                for (let regionCount = 0, totalRegions = countryList[i].children.length; regionCount < totalRegions; regionCount++){
                    currentRegionName = countryList[i].children[regionCount].name;
                    currentRegionUrl = countryList[i].children[regionCount].url;
                    currentRegionList.innerHTML = (currentRegionList.innerHTML + "<li><a href='" + currentRegionUrl + "'>" + currentRegionName + "<i class='fal fa-chevron-right icon'></i></a></li>"); 
                }
            }
        }
    }

    fetch('https://bcapi.greatwesternwine.co.uk/catalog/flattened-categories/countries')
        .then(function(response) {
            return response.json();
        })
        .then(function(returnedJson) {
            displayRegions(returnedJson)
        });

</script>